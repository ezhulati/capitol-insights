<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Capitol Insights Content Manager</title>
  
  <!-- Disable Content Security Policy to allow all connections -->
  <meta http-equiv="Content-Security-Policy" content="default-src *; connect-src *; script-src * 'unsafe-inline' 'unsafe-eval'; style-src * 'unsafe-inline'; img-src * data: blob:; frame-src *;">
  
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      padding: 0;
      margin: 0;
    }
    .redirect-message {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: white;
      z-index: 9999;
      text-align: center;
      padding: 20px;
    }
    .loader {
      border: 5px solid #f3f3f3;
      border-radius: 50%;
      border-top: 5px solid #3498db;
      width: 40px;
      height: 40px;
      animation: spin 2s linear infinite;
      margin-bottom: 20px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="redirect-message">
    <div class="loader"></div>
    <h2>Loading Netlify CMS</h2>
    <p>You'll be redirected to the admin interface momentarily...</p>
  </div>

  <!-- Include the Netlify Identity Widget -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  
  <!-- Include the script that powers Netlify CMS -->
  <script src="https://unpkg.com/netlify-cms@^2.10.0/dist/netlify-cms.js"></script>

  <script>
    console.log("Admin loading...");
    
    // Configure Netlify CMS manually
    window.CMS.init({
      config: {
        backend: {
          name: 'git-gateway',
          branch: 'main',
        },
        media_folder: 'public/uploads',
        public_folder: '/uploads',
        collections: [
          {
            name: 'posts',
            label: 'Blog Posts',
            folder: 'content/posts',
            create: true,
            slug: '{{slug}}',
            fields: [
              { label: 'Title', name: 'title', widget: 'string' },
              { label: 'Body', name: 'body', widget: 'markdown' }
            ]
          }
        ]
      }
    });

    // Initialize Netlify Identity
    if (window.netlifyIdentity) {
      window.netlifyIdentity.on("init", user => {
        if (!user) {
          window.netlifyIdentity.on("login", () => {
            document.location.href = "/admin-simple.html";
          });
        }
      });
    }
    
    // Hide the redirect message when CMS is loaded
    window.CMS.registerEventListener({
      name: 'preSave',
      handler: () => {
        document.querySelector('.redirect-message').style.display = 'none';
      }
    });
    
    setTimeout(() => {
      document.querySelector('.redirect-message').style.display = 'none';
    }, 5000);
  </script>
</body>
</html>
