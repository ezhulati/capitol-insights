<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Capitol Insights - Accept Invitation</title>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      line-height: 1.6;
      color: #333;
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
      text-align: center;
    }
    .container {
      margin-top: 50px;
    }
    h1 {
      color: #102A43;
      margin-bottom: 20px;
    }
    .logo {
      margin-bottom: 30px;
      max-width: 200px;
    }
    .message {
      background-color: #f4f4f7;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
    }
    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border-left-color: #102A43;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .error {
      color: #d32f2f;
      padding: 15px;
      border: 1px solid #d32f2f;
      border-radius: 8px;
      display: none;
    }
  </style>
  <!-- Netlify Identity Widget -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
</head>
<body>
  <div class="container">
    <h1>Capitol Insights</h1>
    <div id="processing" class="message">
      <p>Processing your invitation...</p>
      <div class="spinner"></div>
    </div>
    <div id="success" class="message" style="display: none;">
      <p>Invitation accepted! You'll be redirected to the admin panel in a moment.</p>
    </div>
    <div id="error" class="error">
      <p>There was an error processing your invitation. Please try again or contact the administrator.</p>
      <p id="error-details"></p>
    </div>
  </div>

  <script>
    // Function to extract query parameters
    function getQueryParam(name) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name);
    }

    // Function to extract hash parameters
    function getHashParam(name) {
      const hash = window.location.hash.substring(1);
      const params = new URLSearchParams(hash);
      return params.get(name);
    }

    // Process the invitation
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Invite page loaded - Processing invitation');
      
      // Try to get the token from various sources
      let token = getQueryParam('invite_token') || getHashParam('invite_token');
      
      // If no token in query params, check if it's in the hash format #invite_token=xyz
      if (!token && window.location.hash.startsWith('#invite_token=')) {
        token = window.location.hash.replace('#invite_token=', '');
      }

      if (!token) {
        showError('No invitation token found in the URL. Please check your invitation link.');
        return;
      }

      console.log('Found invitation token, waiting for Netlify Identity to initialize');
      
      // Wait for Netlify Identity to be available
      const checkNetlifyIdentity = setInterval(() => {
        if (window.netlifyIdentity) {
          clearInterval(checkNetlifyIdentity);
          console.log('Netlify Identity is available, processing invite');
          
          try {
            // Process the invite token
            console.log('Opening signup modal and processing token');
            window.netlifyIdentity.open('signup');
            
            // Accept the invitation
            window.netlifyIdentity.gotrue.acceptInvite(token, null, false)
              .then(() => {
                console.log('Invitation successfully accepted');
                document.getElementById('processing').style.display = 'none';
                document.getElementById('success').style.display = 'block';
                
                // Redirect to admin after a short delay
                setTimeout(() => {
                  window.location.href = '/admin/';
                }, 2000);
              })
              .catch(err => {
                console.error('Error accepting invitation:', err);
                showError('Error accepting invitation: ' + (err.message || 'Unknown error'));
              });
          } catch (error) {
            console.error('Exception during invitation processing:', error);
            showError('Exception during invitation processing: ' + (error.message || 'Unknown error'));
          }
        } else {
          console.log('Waiting for Netlify Identity to load...');
        }
      }, 500);

      // Set a timeout to stop checking if it takes too long
      setTimeout(() => {
        clearInterval(checkNetlifyIdentity);
        if (!window.netlifyIdentity) {
          showError('Netlify Identity failed to load after 10 seconds. Please refresh the page or try again later.');
        }
      }, 10000);
    });

    // Show error message
    function showError(message) {
      document.getElementById('processing').style.display = 'none';
      document.getElementById('error').style.display = 'block';
      document.getElementById('error-details').textContent = message;
    }
  </script>
</body>
</html>
